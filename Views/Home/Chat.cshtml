@{
    ViewData["Title"] = "Reader's Chathub";
    var username = ViewBag.Username;
}

<div class="content-wrapper">

    <h2 style="font-size: 2rem; padding: 0 0 1rem 0;">
        <i data-lucide="message-circle"></i> Reader's Chathub
    </h2>

    <!-- current user -->
    <div class="card" style="max-width: 700px; margin: 0 auto;">
        <!-- the message -->
        <div id="messages" style="height: 300px; overflow-y: auto; background-color: #1f2937; padding: 1rem; border-radius: 6px; border: 1px solid #30363d;">
        </div>

        <!-- input area with embedded send button -->
        <div style="margin-top: 1rem; position: relative; display: flex; align-items: center;">
            <input type="text" 
                   id="messageInput" 
                   placeholder="Type your message..." 
                   style="padding: 14px 120px 14px 16px; border-radius: 8px; border: 1px solid #4b5563; background-color: #1f2937; color: #f9fafb; width: 100%; height: 52px; box-sizing: border-box; font-size: 15px;" />
            <button id="sendButton" 
                    class="btn btn-blue" 
                    style="position: absolute; right: 6px; height: 40px; padding: 10px 18px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="send"></i> Send
            </button>
        </div>
    </div>
</div>

<!-- SignalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
    const username = "@username";
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    connection.on("ReceiveMessage", function (user, message) {
        const msg = document.createElement("div");
        msg.innerHTML = `<strong>${user}</strong>: ${message}`;
        document.getElementById("messages").appendChild(msg);
        // auto roll to buttom
        const messagesBox = document.getElementById("messages");
        messagesBox.scrollTop = messagesBox.scrollHeight;
    });

    connection.start().catch(err => console.error(err.toString()));

    document.getElementById("sendButton").addEventListener("click", function (event) {
        const message = document.getElementById("messageInput").value;
        if (message.trim() === "") return;
        connection.invoke("SendMessage", username, message).catch(err => console.error(err.toString()));
        document.getElementById("messageInput").value = "";
        event.preventDefault();
    });
</script>